---
import Layout from '../layouts/BaseLayout.astro';
import Navbar from '../components/Navbar.astro';
import "./Documents.css";

const pages = [
  { href: "/Posts", pageName: "Posts" },
  { href: "/Documents", pageName: "Documents" },
  { href: "#projects", pageName: "Projects" },
  { href: "#about", pageName: "About" }
];

const title = "Documents - Nathan Waltz";
const description = "View and download my technical documents and papers.";

const documents = [
  { id: "alr", name: "ALR Document", file: "/ALRPDFNathanWaltz.pdf" },
  { id: "simpl", name: "SIMPL Document", file: "/SIMPLPDFNathanWaltz.pdf" },
  { id: "program-study", name: "Program of Study Request", file: "/program-study-request.pdf" },
  { id: "transfer-coursework", name: "Petition to Transfer Graduate Coursework", file: "/PetitionToTransferGraduateCoursework.pdf" }
];
---

<Layout title={title} description={description}>
  <Navbar pages={pages} />

  <main class="documents-page">
    <div class="documents-container">
      <header class="documents-header">
        <h1 class="documents-title">Documents</h1>
        <p class="documents-description">
          Browse and view my documents.
        </p>
      </header>

      <div class="viewer-controls">
        <label for="document-select" class="select-label">Select Document</label>
        <div class="select-wrapper">
          <select id="document-select" class="document-select">
            {documents.map((doc, index) => (
              <option value={doc.file} selected={index === 0}>{doc.name}</option>
            ))}
          </select>
          <svg class="select-arrow" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
          </svg>
        </div>
        <a id="download-link" href={documents[0].file} download class="download-btn">
          <svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path d="M10.75 2.75a.75.75 0 00-1.5 0v8.614L6.295 8.235a.75.75 0 10-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 00-1.09-1.03l-2.955 3.129V2.75z" />
            <path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5z" />
          </svg>
          Download
        </a>
      </div>

      <div class="pdf-viewer-container">
        <div id="pdf-loading" class="pdf-loading">
          <div class="loading-spinner"></div>
          <span>Loading document...</span>
        </div>
        <canvas id="pdf-canvas"></canvas>
        <div id="pdf-error" class="pdf-error" style="display: none;">
          <p>Unable to load document. Please try downloading instead.</p>
        </div>
      </div>

      <div class="pdf-navigation">
        <button id="prev-page" class="nav-btn" disabled>
          <svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
          </svg>
          Previous
        </button>
        <span class="page-info">
          Page <span id="page-num">1</span> of <span id="page-count">-</span>
        </span>
        <button id="next-page" class="nav-btn" disabled>
          Next
          <svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
          </svg>
        </button>
      </div>

      <footer class="viewer-footer">
        <p class="pdfjs-attribution">
          Rendered with <a href="https://mozilla.github.io/pdf.js/" target="_blank" rel="noopener noreferrer">pdf.js</a> for consistent visualization across platforms.
        </p>
      </footer>
    </div>
  </main>
</Layout>

<script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.mjs" type="module"></script>
<script type="module">
  const pdfjsLib = await import('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.mjs');
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.worker.min.mjs';

  let pdfDoc = null;
  let pageNum = 1;
  let pageRendering = false;
  let pageNumPending = null;
  const scale = 1.5;
  const canvas = document.getElementById('pdf-canvas');
  const ctx = canvas.getContext('2d');

  const documentSelect = document.getElementById('document-select');
  const downloadLink = document.getElementById('download-link');
  const prevBtn = document.getElementById('prev-page');
  const nextBtn = document.getElementById('next-page');
  const pageNumSpan = document.getElementById('page-num');
  const pageCountSpan = document.getElementById('page-count');
  const loadingEl = document.getElementById('pdf-loading');
  const errorEl = document.getElementById('pdf-error');

  function showLoading() {
    loadingEl.style.display = 'flex';
    canvas.style.display = 'none';
    errorEl.style.display = 'none';
  }

  function hideLoading() {
    loadingEl.style.display = 'none';
    canvas.style.display = 'block';
  }

  function showError() {
    loadingEl.style.display = 'none';
    canvas.style.display = 'none';
    errorEl.style.display = 'flex';
  }

  function renderPage(num) {
    pageRendering = true;

    pdfDoc.getPage(num).then(function(page) {
      const viewport = page.getViewport({ scale: scale });

      // Handle high DPI displays
      const outputScale = window.devicePixelRatio || 1;
      canvas.width = Math.floor(viewport.width * outputScale);
      canvas.height = Math.floor(viewport.height * outputScale);
      canvas.style.width = Math.floor(viewport.width) + 'px';
      canvas.style.height = Math.floor(viewport.height) + 'px';

      const transform = outputScale !== 1
        ? [outputScale, 0, 0, outputScale, 0, 0]
        : null;

      const renderContext = {
        canvasContext: ctx,
        transform: transform,
        viewport: viewport
      };

      const renderTask = page.render(renderContext);

      renderTask.promise.then(function() {
        pageRendering = false;
        if (pageNumPending !== null) {
          renderPage(pageNumPending);
          pageNumPending = null;
        }
      });
    });

    pageNumSpan.textContent = num;
    updateNavButtons();
  }

  function queueRenderPage(num) {
    if (pageRendering) {
      pageNumPending = num;
    } else {
      renderPage(num);
    }
  }

  function updateNavButtons() {
    prevBtn.disabled = pageNum <= 1;
    nextBtn.disabled = !pdfDoc || pageNum >= pdfDoc.numPages;
  }

  function onPrevPage() {
    if (pageNum <= 1) return;
    pageNum--;
    queueRenderPage(pageNum);
  }

  function onNextPage() {
    if (!pdfDoc || pageNum >= pdfDoc.numPages) return;
    pageNum++;
    queueRenderPage(pageNum);
  }

  function loadPdf(url) {
    showLoading();
    pageNum = 1;

    pdfjsLib.getDocument(url).promise.then(function(pdf) {
      pdfDoc = pdf;
      pageCountSpan.textContent = pdf.numPages;
      hideLoading();
      renderPage(pageNum);
    }).catch(function(error) {
      console.error('Error loading PDF:', error);
      showError();
    });
  }

  // Event listeners
  prevBtn.addEventListener('click', onPrevPage);
  nextBtn.addEventListener('click', onNextPage);

  documentSelect.addEventListener('change', function() {
    const selectedUrl = this.value;
    downloadLink.href = selectedUrl;
    loadPdf(selectedUrl);
  });

  // Keyboard navigation
  document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft') {
      onPrevPage();
    } else if (e.key === 'ArrowRight') {
      onNextPage();
    }
  });

  // Load initial PDF
  loadPdf(documentSelect.value);
</script>
